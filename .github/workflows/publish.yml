name: Publish OSDO Actions

on:
  push:
    branches:
      - main
    paths:
      - "actions/**"
  workflow_dispatch:
    inputs:
      action-name:
        description: 'Action to publish (or "all")'
        required: true
        default: "all"
      version:
        description: "Version to publish (semver: v1.0.0)"
        required: true
      dry-run:
        description: "Dry run (no actual publish)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write

jobs:
  detect-changes:
    name: "Detect Changed Actions"
    runs-on: ubuntu-latest
    outputs:
      changed-actions: ${{ steps.detect.outputs.actions }}
      has-changes: ${{ steps.detect.outputs.has-changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changed Actions
        id: detect
        run: |
          # Get list of changed actions since last commit
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - use specified action
            if [ "${{ github.event.inputs.action-name }}" == "all" ]; then
              actions=$(ls -d actions/*/ | sed 's|actions/||' | sed 's|/$||' | tr '\n' ',' | sed 's/,$//')
            else
              actions="${{ github.event.inputs.action-name }}"
            fi
          else
            # Auto trigger - detect from git diff
            changed_files=$(git diff --name-only HEAD^ HEAD | grep '^actions/' || echo "")
            
            if [ -z "$changed_files" ]; then
              echo "has-changes=false" >> $GITHUB_OUTPUT
              echo "actions=" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            # Extract unique action names
            actions=$(echo "$changed_files" | cut -d'/' -f2 | sort -u | tr '\n' ',' | sed 's/,$//')
          fi

          echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "actions=$actions" >> $GITHUB_OUTPUT
          echo "Detected changed actions: $actions"

  validate-actions:
    name: "Validate Actions"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    strategy:
      matrix:
        action: ${{ fromJson(format('["{0}"]', needs.detect-changes.outputs.changed-actions)) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate action.yml
        run: |
          action_file="actions/${{ matrix.action }}/action.yml"

          if [ ! -f "$action_file" ]; then
            echo "::error::Action file not found: $action_file"
            exit 1
          fi

          # Install actionlint if needed
          if ! command -v actionlint &> /dev/null; then
            bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
            sudo mv actionlint /usr/local/bin/
          fi

          # Validate YAML
          actionlint "$action_file" || echo "::warning::Validation warnings for ${{ matrix.action }}"

          echo "âœ… Action ${{ matrix.action }} validated successfully"

      - name: Check Required Fields
        run: |
          action_file="actions/${{ matrix.action }}/action.yml"

          # Check for required fields
          if ! grep -q "^name:" "$action_file"; then
            echo "::error::Missing 'name' field in $action_file"
            exit 1
          fi

          if ! grep -q "^description:" "$action_file"; then
            echo "::error::Missing 'description' field in $action_file"
            exit 1
          fi

          if ! grep -q "^runs:" "$action_file"; then
            echo "::error::Missing 'runs' field in $action_file"
            exit 1
          fi

          echo "âœ… All required fields present"

  test-actions:
    name: "Test Actions"
    runs-on: ubuntu-latest
    needs: [detect-changes, validate-actions]
    if: needs.detect-changes.outputs.has-changes == 'true'
    strategy:
      matrix:
        action: ${{ fromJson(format('["{0}"]', needs.detect-changes.outputs.changed-actions)) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Action Syntax
        run: |
          echo "Testing action: ${{ matrix.action }}"

          # Basic syntax test - try to parse the action
          action_file="actions/${{ matrix.action }}/action.yml"

          if command -v yq &> /dev/null; then
            yq eval '.' "$action_file" > /dev/null && echo "âœ… YAML syntax valid"
          else
            echo "â„¹ï¸ yq not available, skipping detailed YAML validation"
          fi

  create-tags:
    name: "Create Version Tags"
    runs-on: ubuntu-latest
    needs: [detect-changes, validate-actions, test-actions]
    if: needs.detect-changes.outputs.has-changes == 'true' && github.event.inputs.dry-run != 'true'
    strategy:
      matrix:
        action: ${{ fromJson(format('["{0}"]', needs.detect-changes.outputs.changed-actions)) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version
        id: version
        run: |
          action_name="${{ matrix.action }}"

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            version="${{ github.event.inputs.version }}"
          else
            # Auto-determine version from git tags
            latest_tag=$(git tag -l "${action_name}/v*" | sort -V | tail -n1)
            
            if [ -z "$latest_tag" ]; then
              # No tags yet, start with v1.0.0
              version="v1.0.0"
            else
              # Increment patch version
              current_version=$(echo "$latest_tag" | sed "s|${action_name}/||")
              # Simple patch increment (v1.0.0 -> v1.0.1)
              version=$(echo "$current_version" | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
            fi
          fi

          echo "version=$version" >> $GITHUB_OUTPUT
          echo "tag=${action_name}/${version}" >> $GITHUB_OUTPUT
          echo "Will tag as: ${action_name}/${version}"

      - name: Create Tag
        run: |
          tag="${{ steps.version.outputs.tag }}"

          # Check if tag exists
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "::warning::Tag $tag already exists, skipping"
            exit 0
          fi

          # Create and push tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "$tag" -m "Release ${{ matrix.action }} ${{ steps.version.outputs.version }}"
          git push origin "$tag"

          echo "âœ… Created tag: $tag"

  create-releases:
    name: "Create GitHub Releases"
    runs-on: ubuntu-latest
    needs: [detect-changes, create-tags]
    if: needs.detect-changes.outputs.has-changes == 'true' && github.event.inputs.dry-run != 'true'
    strategy:
      matrix:
        action: ${{ fromJson(format('["{0}"]', needs.detect-changes.outputs.changed-actions)) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Version
        id: version
        run: |
          action_name="${{ matrix.action }}"
          latest_tag=$(git tag -l "${action_name}/v*" | sort -V | tail -n1)
          version=$(echo "$latest_tag" | sed "s|${action_name}/||")

          echo "version=$version" >> $GITHUB_OUTPUT
          echo "tag=$latest_tag" >> $GITHUB_OUTPUT

      - name: Generate Changelog
        id: changelog
        run: |
          action_name="${{ matrix.action }}"
          tag="${{ steps.version.outputs.tag }}"

          # Get commits since last tag
          prev_tag=$(git tag -l "${action_name}/v*" | sort -V | tail -n2 | head -n1)

          if [ -z "$prev_tag" ]; then
            commits=$(git log --pretty=format:"- %s (%h)" --grep="^feat\|^fix\|^chore" -- "actions/${action_name}/" | head -20)
          else
            commits=$(git log ${prev_tag}..${tag} --pretty=format:"- %s (%h)" --grep="^feat\|^fix\|^chore" -- "actions/${action_name}/" | head -20)
          fi

          if [ -z "$commits" ]; then
            commits="- Initial release or minor updates"
          fi

          # Create changelog
          cat > changelog.md <<EOF
          ## Changes in ${{ matrix.action }} ${{ steps.version.outputs.version }}

          $commits

          ## Usage

          \`\`\`yaml
          - name: ${{ matrix.action }}
            uses: opensecdevops/osdo-actions/actions/${{ matrix.action }}@${{ steps.version.outputs.tag }}
            with:
              # Add your inputs here
          \`\`\`

          ## Full Documentation

          See [actions/${{ matrix.action }}/action.yml](https://github.com/opensecdevops/osdo-actions/blob/${{ steps.version.outputs.tag }}/actions/${{ matrix.action }}/action.yml) for all available inputs and outputs.
          EOF

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "${{ matrix.action }} ${{ steps.version.outputs.version }}"
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: "Publish Summary"
    runs-on: ubuntu-latest
    needs: [detect-changes, create-releases]
    if: always() && needs.detect-changes.outputs.has-changes == 'true'
    steps:
      - name: Generate Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # ðŸ“¦ OSDO Actions Publication Report

          ## Published Actions

          $(echo "${{ needs.detect-changes.outputs.changed-actions }}" | tr ',' '\n' | while read action; do
            echo "- âœ… **$action**"
          done)

          ## Status

          - **Validation:** ${{ needs.validate-actions.result }}
          - **Testing:** ${{ needs.test-actions.result }}
          - **Tagging:** ${{ needs.create-tags.result }}
          - **Releases:** ${{ needs.create-releases.result }}

          ## Next Steps

          Actions are now published and available for use:

          \`\`\`yaml
          uses: opensecdevops/osdo-actions/actions/<action-name>@<action-name>/v<version>
          \`\`\`
          EOF
