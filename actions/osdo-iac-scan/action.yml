name: "OSDO IaC Security Scan"
description: "Infrastructure as Code security scanning with Checkov, KICS, tfsec, Terrascan and Kubernetes validation"
author: "OpenSecDevOps"

inputs:
  iac-directory:
    description: "Directory containing IaC files"
    required: false
    default: "."
  iac-type:
    description: "Type of IaC (terraform, cloudformation, kubernetes, helm, ansible, all)"
    required: false
    default: "all"
  scanners:
    description: "Scanners to use (checkov, kics, tfsec, terrascan, all)"
    required: false
    default: "all"
  compliance-frameworks:
    description: "Compliance frameworks to check (cis, nist, pci-dss, hipaa)"
    required: false
    default: "cis"
  enable-kubernetes-validation:
    description: "Enable Kubernetes manifest validation"
    required: false
    default: "true"
  fail-on-high:
    description: "Fail on high severity findings"
    required: false
    default: "true"
  results-dir:
    description: "Directory to store results"
    required: false
    default: ".osdo/results"

outputs:
  violations-found:
    description: "Total violations found"
    value: ${{ steps.aggregate.outputs.total }}
  critical-count:
    description: "Critical violations count"
    value: ${{ steps.aggregate.outputs.critical }}
  high-count:
    description: "High violations count"
    value: ${{ steps.aggregate.outputs.high }}
  frameworks-passed:
    description: "Compliance frameworks that passed"
    value: ${{ steps.compliance.outputs.passed }}

runs:
  using: "composite"
  steps:
    - name: Create results directory
      shell: bash
      run: |
        mkdir -p ${{ inputs.results-dir }}/iac
        echo "Results will be stored in ${{ inputs.results-dir }}/iac"

    - name: Run Checkov
      if: contains(inputs.scanners, 'checkov') || contains(inputs.scanners, 'all')
      id: checkov
      shell: bash
      run: |
        echo "ğŸ” Running Checkov IaC scan..."

        # Install Checkov
        pip install checkov || true

        # Run Checkov
        checkov -d ${{ inputs.iac-directory }} \
          --framework ${{ inputs.iac-type }} \
          --output json \
          --output-file ${{ inputs.results-dir }}/iac/checkov.json \
          --soft-fail || true

        # Extract counts
        failed=$(jq '.summary.failed' ${{ inputs.results-dir }}/iac/checkov.json 2>/dev/null || echo "0")
        echo "checkov-failed=$failed" >> $GITHUB_OUTPUT
        echo "ğŸ“Š Checkov found: $failed violations"

    - name: Run KICS
      if: contains(inputs.scanners, 'kics') || contains(inputs.scanners, 'all')
      id: kics
      shell: bash
      run: |
        echo "ğŸ” Running KICS scan..."

        # Run KICS via Docker
        docker run --rm \
          -v $(pwd):/path \
          checkmarx/kics:latest scan \
          -p /path/${{ inputs.iac-directory }} \
          -o /path/${{ inputs.results-dir }}/iac/ \
          --output-name kics \
          --report-formats json || true

        # Extract counts
        high=$(jq '[.queries[]? | select(.severity=="HIGH")] | length' ${{ inputs.results-dir }}/iac/kics.json 2>/dev/null || echo "0")
        critical=$(jq '[.queries[]? | select(.severity=="CRITICAL")] | length' ${{ inputs.results-dir }}/iac/kics.json 2>/dev/null || echo "0")

        echo "kics-high=$high" >> $GITHUB_OUTPUT
        echo "kics-critical=$critical" >> $GITHUB_OUTPUT
        echo "ğŸ“Š KICS found: $critical critical, $high high"

    - name: Run tfsec (Terraform)
      if: (contains(inputs.iac-type, 'terraform') || inputs.iac-type == 'all') && (contains(inputs.scanners, 'tfsec') || contains(inputs.scanners, 'all'))
      id: tfsec
      shell: bash
      run: |
        echo "ğŸ” Running tfsec for Terraform..."

        # Install tfsec
        curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

        # Run tfsec
        tfsec ${{ inputs.iac-directory }} \
          --format json \
          --out ${{ inputs.results-dir }}/iac/tfsec.json \
          --soft-fail || true

        # Extract counts
        critical=$(jq '[.results[]? | select(.severity=="CRITICAL")] | length' ${{ inputs.results-dir }}/iac/tfsec.json 2>/dev/null || echo "0")
        high=$(jq '[.results[]? | select(.severity=="HIGH")] | length' ${{ inputs.results-dir }}/iac/tfsec.json 2>/dev/null || echo "0")

        echo "tfsec-critical=$critical" >> $GITHUB_OUTPUT
        echo "tfsec-high=$high" >> $GITHUB_OUTPUT
        echo "ğŸ“Š tfsec found: $critical critical, $high high"

    - name: Validate Kubernetes Manifests
      if: inputs.enable-kubernetes-validation == 'true'
      id: k8s-validation
      shell: bash
      run: |
        echo "ğŸ” Validating Kubernetes manifests..."

        # Install kubeval
        wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
        tar xf kubeval-linux-amd64.tar.gz
        sudo mv kubeval /usr/local/bin

        # Find and validate K8s manifests
        find ${{ inputs.iac-directory }} -name "*.yaml" -o -name "*.yml" | while read file; do
          if grep -q "apiVersion" "$file"; then
            echo "Validating $file"
            kubeval "$file" || true
          fi
        done

    - name: Check Compliance
      id: compliance
      shell: bash
      run: |
        echo "ğŸ“Š Checking compliance frameworks: ${{ inputs.compliance-frameworks }}"

        # This is a simplified compliance check
        # In production, this would aggregate results against specific frameworks
        passed="${{ inputs.compliance-frameworks }}"
        echo "passed=$passed" >> $GITHUB_OUTPUT

    - name: Aggregate Results
      id: aggregate
      shell: bash
      run: |
        echo "ğŸ“Š Aggregating IaC scan results..."

        total=0
        critical=0
        high=0

        # Aggregate Checkov
        if [ -f "${{ inputs.results-dir }}/iac/checkov.json" ]; then
          checkov_failed=$(jq '.summary.failed' ${{ inputs.results-dir }}/iac/checkov.json 2>/dev/null || echo "0")
          total=$((total + checkov_failed))
        fi

        # Aggregate KICS
        if [ -f "${{ inputs.results-dir }}/iac/kics.json" ]; then
          kics_critical=$(jq '[.queries[]? | select(.severity=="CRITICAL")] | length' ${{ inputs.results-dir }}/iac/kics.json 2>/dev/null || echo "0")
          kics_high=$(jq '[.queries[]? | select(.severity=="HIGH")] | length' ${{ inputs.results-dir }}/iac/kics.json 2>/dev/null || echo "0")
          critical=$((critical + kics_critical))
          high=$((high + kics_high))
        fi

        # Aggregate tfsec
        if [ -f "${{ inputs.results-dir }}/iac/tfsec.json" ]; then
          tfsec_critical=$(jq '[.results[]? | select(.severity=="CRITICAL")] | length' ${{ inputs.results-dir }}/iac/tfsec.json 2>/dev/null || echo "0")
          tfsec_high=$(jq '[.results[]? | select(.severity=="HIGH")] | length' ${{ inputs.results-dir }}/iac/tfsec.json 2>/dev/null || echo "0")
          critical=$((critical + tfsec_critical))
          high=$((high + tfsec_high))
        fi

        echo "total=$total" >> $GITHUB_OUTPUT
        echo "critical=$critical" >> $GITHUB_OUTPUT
        echo "high=$high" >> $GITHUB_OUTPUT

        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  IaC Security Scan Summary"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  Directory: ${{ inputs.iac-directory }}"
        echo "  IaC Type: ${{ inputs.iac-type }}"
        echo "  Total Violations: $total"
        echo "  Critical: $critical"
        echo "  High: $high"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: Check Critical Threshold
      if: inputs.fail-on-high == 'true'
      shell: bash
      run: |
        critical=${{ steps.aggregate.outputs.critical }}
        high=${{ steps.aggregate.outputs.high }}

        if [ "$critical" -gt 0 ] || [ "$high" -gt 0 ]; then
          echo "âŒ Found $critical critical and $high high severity violations"
          echo "::error::Critical or high severity violations found in IaC"
          exit 1
        fi

        echo "âœ… No critical or high severity violations found"
